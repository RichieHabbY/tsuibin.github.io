<!DOCTYPE html>
<html>
  <head>
    
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="description" content="">
    <meta name="author" content="">
    
    <title>Uliweb Zone - 教程 - 一步一步学内核(Linux kernel) - 驱动模块之网卡</title>
    <!-- toplinks -->
<script type="text/javascript" src="/static/jquery/jquery-1.7.2.min.js?ver=2"></script>
<script type="text/javascript" src="/static/jsutils/json2.js?ver=2"></script>
<!--[if lt IE 9]>
<script type="text/javascript" src="/static/bootstrap/asset/html5.js?ver=2"></script>
<![endif]-->
<link rel="stylesheet" type="text/css" href="/static/bootstrap/2.2.0/bootstrap.min.css?ver=2"/>
<script type="text/javascript" src="/static/bootstrap/2.2.0/js/bootstrap.min.js?ver=2"></script>
<link rel="stylesheet" type="text/css" href="/static/bootstrap_extend.css?ver=2"/>
<link rel="stylesheet" type="text/css" href="/static/jquery/ui/css/redmond/jquery-ui-1.8.16.custom.css?ver=2"/>
<link rel="stylesheet" type="text/css" href="/static/pnotify/1.2.0/jquery.pnotify.default.css?ver=2"/>
<link rel="stylesheet" type="text/css" href="/static/pnotify/1.2.0/jquery.pnotify.default.icons.css?ver=2"/>
<script type="text/javascript" src="/static/pnotify/1.2.0/jquery.pnotify.min.js?ver=2"></script>
<link rel="stylesheet" type="text/css" href="/static/bootheme/bootheme.css?ver=2"/>
<link rel="stylesheet" type="text/css" href="/static/tutorials/tutorials.css?ver=2"/>
<link rel="stylesheet" type="text/css" href="/static/poshytip/tip-twitter/tip-twitter.css?ver=2"/>
<link rel="stylesheet" type="text/css" href="/static/poshytip/tip-yellow/tip-yellow.css?ver=2"/>
<link rel="stylesheet" type="text/css" href="/static/poshytip/tip-yellowsimple/tip-yellowsimple.css?ver=2"/>
<script type="text/javascript" src="/static/poshytip/jquery.poshytip.js?ver=2"></script>
<script type="text/javascript" src="/static/jquery/ui/js/jquery-ui-1.8.16.custom.min.js?ver=2"></script>
<script type="text/javascript" src="/static/jquery/ui/js/jquery.ui.datepicker.zh.js?ver=2"></script>
<link rel="stylesheet" type="text/css" href="/static/bootstrap/asset/prettify.css?ver=2"/>
<script type="text/javascript" src="/static/bootstrap/asset/prettify.js?ver=2"></script>
<link rel="stylesheet" type="text/css" href="/static/pageslide/jquery.pageslide.css?ver=2"/>
<script type="text/javascript" src="/static/jqutils/jquery.form.js?ver=2"></script>
<link rel="stylesheet" type="text/css" href="/static/jqutils/jqutils.css?ver=2"/>
<script type="text/javascript" src="/static/jqutils/jqrselect.js?ver=2"></script>
<script type="text/javascript" src="/static/jqutils/jqutils.js?ver=2"></script>
<link rel="stylesheet" type="text/css" href="/static/toc/toc.css?ver=2"/>
<link rel="stylesheet" type="text/css" href="/static/bootstrap/fontawesome/css/font-awesome.css?ver=2"/>
<!--[if IE 7]>
  <link rel="stylesheet" href="/static/bootstrap/fontawesome/css/font-awesome-ie7.css">
<![endif]-->

<script type="text/javascript" src="/static/tutorials/comment.js?ver=2"></script>
<link rel="stylesheet" type="text/css" href="/static/jqutils/ui.totop.css?ver=2"/>
<script type="text/javascript" src="/static/jqutils/jquery.ui.totop.js?ver=2"></script>
<script type="text/javascript" src="/static/jqutils/jquery.hotkeys.js?ver=2"></script>
    
    
  </head>

<body class="bootstrap-body">









<script type="text/javascript">
$.extend($.pnotify.defaults, {"styling":"bootstrap"});
var show_message = function(message, category){
    $.pnotify({
        //pnotify_title: 'Regular Notice',
        pnotify_history: false,
        pnotify_text: message,
        pnotify_type: category || 'success',
        pnotify_animation: 'fade',
        pnotify_before_open: function(pnotify){
           // Position this notice in the center of the screen.
           pnotify.css({
               "top": 1,
               "left": ($(top.window).width() / 2) - (pnotify.width() / 2)
           });
        }
    });
}

$(function(){
    
});
</script>


<script>
// using jQuery
function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie != '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = jQuery.trim(cookies[i]);
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) == (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    crossDomain: false, // obviates need for sameOrigin test
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type)) {
            xhr.setRequestHeader("X-CSRFToken", getCookie('_csrf_token'));
        }
    }
});
</script>




<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
    <div class="container-fluid">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
      <a class="brand" href="#">Uliweb Zone</a>
      <div class="nav-collapse">
        
<ul class="nav">
    
<li><a href="/"><span>Home</span></a></li><li><a href="/forum"><span>Forum</span></a></li><li class="active"><a href="/tutorial"><span>Tutorial</span></a></li><li><a href="/class"><span>Class</span></a></li><li><a href="/user/view"><span>Admin</span></a></li><li><a href="/about"><span>About</span></a></li>



</ul>

      
<style>
#userinfo.btn-toolbar {margin-top:0;margin-bottom:0;font-size:14px;}
#userinfo.btn-toolbar a{vertical-align:middle;}
#userinfo img {
-webkit-border-radius: 3px;
   -moz-border-radius: 3px;
        border-radius: 3px;
}
#userinfo [class^="icon-"], #userinfo [class*=" icon-"], #userinfo [class^="icon-"]:hover, #userinfo [class*=" icon-"]:hover{
    vertical-align:middle;
    margin-bottom:3px;
}
</style>
    

    
        <p class="pull-right user_info">
            <a href="/login">登录</a> | <a href="/register">注册</a>
        </p>
    

    
        
    

      </div><!--/.nav-collapse -->
    </div>
  </div>
</div>

    















<style>
#pageslide {
width:320px;
}
#toc {width:22%;}
/* scrollbar  */
.nano .content      { padding: 10px; }
.nano .pane         { background: #999; }
.nano .pane .slider { background: #111; }

</style>
<div class="container-fluid">
    <div class="row-fluid">
        <div class="span12">
            <ul class="breadcrumb">
              <li>
                <a href="/tutorial">返回</a> <span class="divider">/</span>
              </li>
              <li>
                <a href="/tutorial/read/11.html">一步一步学内核(Linux kernel)</a> <span class="divider">/</span>
              </li>
              <li class="active">
                驱动模块之网卡
              </li>
            </ul>
        </div>
    </div>
    <div class="row-fluid">
        <div class="span9" id="article">
            <!-- Prompt IE 6 users to install Chrome Frame. Remove this if you support IE 6.
      chromium.org/developers/how-tos/chrome-frame-getting-started -->
 <!--[if lt IE 8]><div class="alert alert-info">Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</div><![endif]-->

            <div class="outter">
                <div class="chapter-prev chapter-top animated">
                    <a prev-chapter href="/tutorial/view_chapter/148.html"><i class="icon-arrow-left"></i> 3.4 驱动模块之块设备</a>
                </div>
                <div class="chapter-next chapter-top animated">
                    <a next-chapter href="/tutorial/view_chapter/122.html">3.6 硬件常识 <i class="icon-arrow-right"></i></a>
                </div>
                <div class="expander">&raquo;</div>
                <div class="content-inner rounded_bottom article">
                    <h1>驱动模块之网卡</h1>
                    <div style="margin-top:-10px;margin-bottom:20px;">
                        <!-- 评论 <a id="global-comment-count" href="/tutorial/view_paragraph_comments/95?para=0" class="para-comments-count active right animated">0</a> -->
                            <span class="gray">valley 于 2013-01-11 06:49:17+00:00 更新</span>
                            <span class="label label-info">访问次数：356</span>
                        
                    </div>
                    
                    
                
                    <pre class="prettyprint linenums pre-scrollable"><code>
//-------------------------------------------------------------------
//	recv1000.c
//
//	Receives a packet via the Intel 82573L Pro1000 controller.
//	For code-simplicity we made some unusual design-decisions:
//	we used the minimum allowed number of receive-descriptors,
//	and we let the network controller "own" all of them; hence 
//	a received packet will be overwritten if it remains unread 
//	while eight or more additional packets are being received.
//	In addition, our 'read()' method discards packet-data that
//	exceeds the size of the buffer supplied by an application.
//	(Such 'defects' offer opportunities for future exercises!) 
//	Furthermore, we assume a packet-format in which the number 
//	of actual data-bytes is stored in the (16-bit) field which
//	immediately follows the (14-byte) ethernet-header (as will
//	be transmitted from our accompanying 'xmit1000.c' module). 
//
//	NOTE: Written and tested for Linux kernel version 2.6.22.5.
//
//	programmer: ALLAN CRUSE
//	written on: 25 NOV 2007
//-------------------------------------------------------------------

#include &lt;linux/module.h&gt;	// for init_module() 
#include &lt;linux/proc_fs.h&gt;	// for create_proc_info_entry() 
#include &lt;linux/pci.h&gt;		// for pci_get_device()
#include &lt;linux/interrupt.h&gt;	// for request_irq()
#include &lt;asm/uaccess.h&gt;	// for copy_to_user()
#include &lt;asm/io.h&gt;		// for ioremap()

#define VENDOR_ID	0x8086	// Intel Corporation
#define DEVICE_ID	0x109A	// 82573L nic device
//#define DEVICE_ID	0x10B9	// 82572EI nic device
//#define DEVICE_ID	0x107C	// 82541PI nic device
#define KMEM_SIZE       (4&lt;&lt;12)	// kernel memory allocation
#define INTR_MASK   0xFFFFFFFF	// interrupts to recognize

typedef struct	{
		unsigned long long	base_addr;
		unsigned short		pkt_length;
		unsigned short		check_sum;
		unsigned char		desc_stat;
		unsigned char		desc_errs;
		unsigned short		vlan_tag;
		} RX_DESCRIPTOR;

char modname[] = "recv1000";
char devname[] = "nic";
int my_major = 97;
struct pci_dev 	*devp;
unsigned char	mac[6];
unsigned int	irq;
unsigned long	iomem_base;
unsigned long	iomem_size;
void		*io, *kmem;
unsigned long	physaddr;
unsigned long	descaddr;
RX_DESCRIPTOR	*rxdesc;
wait_queue_head_t wq_rx;

enum 	{	
	E1000_CTRL 	= 0x0000,	// Device Control register	
	E1000_STATUS 	= 0x0008,	// Device Status register
	E1000_CTRL_EXT 	= 0x0018, 	// Device Control Extension
	E1000_ICR 	= 0x00C0,	// Interrupt Cause Read
	E1000_ICS 	= 0x00C8,	// Interrupt Cause Set
	E1000_IMS 	= 0x00D0,	// Interrupt Mask Set/Read
	E1000_IMC 	= 0x00D8,	// Interrupt Mask Clear
	E1000_RCTL 	= 0x0100,	// Receive Control register
	E1000_PSRCTL 	= 0x2170,	// Packet-Split Receive Control
	E1000_RDBAL 	= 0x2800,	// Rx-Descriptor Base-Address (low)	
	E1000_RDBAH 	= 0x2804,	// Rx-Descriptor Base-Address (High)
	E1000_RDLEN 	= 0x2808,	// Rx-Descriptor array Length
	E1000_RDH 	= 0x2810,	// Receive Descriptor Head
	E1000_RDT 	= 0x2818,	// Receive Descriptor Tail
	E1000_RDTR 	= 0x2820,	// Rx-interrupt Delay Timer Register
	E1000_RXDCTL 	= 0x2828,	// Receive Descriptor Control
	E1000_RADV 	= 0x282C,	// Rx-interrupt Absolute Delay Value
	E1000_RXERRC	= 0x400C,	// Receive Errors Count 
	E1000_TPR 	= 0x40D0,	// Total Packets Received
	E1000_RXCSUM 	= 0x5000,	// Receive Checksum Control
	E1000_RFCTL	= 0x5008,	// Receive Filter Control
	E1000_RA 	= 0x5400, 	// Receive-filter Array
	}; 


irqreturn_t my_isr( int irq, void *dev_id )
{
	static int	reps = 0;
	int	intr_cause = ioread32( io + E1000_ICR );

	if ( intr_cause == 0 ) return IRQ_NONE;

	printk( " RECV1000: #%d CAUSE=%08X ", ++reps, intr_cause );
	if ( intr_cause &amp; (1&lt;&lt;0 ) ) printk( "TXDW " );
	if ( intr_cause &amp; (1&lt;&lt;1 ) ) printk( "TXQE " );
	if ( intr_cause &amp; (1&lt;&lt;2 ) ) printk( "LSC " );
	if ( intr_cause &amp; (1&lt;&lt;4 ) ) printk( "RXDMT0 " );
	if ( intr_cause &amp; (1&lt;&lt;6 ) ) printk( "RXO (Receiver Overrun) " );
	if ( intr_cause &amp; (1&lt;&lt;7 ) ) printk( "RXT0 (Receiver Timeout) " );
	if ( intr_cause &amp; (1&lt;&lt;9 ) ) printk( "MDAC " );
	if ( intr_cause &amp; (1&lt;&lt;15 ) ) printk( "TXDLOW " );
	if ( intr_cause &amp; (1&lt;&lt;16 ) ) printk( "SRPD " );
	if ( intr_cause &amp; (1&lt;&lt;17 ) ) printk( "ACK " );
	printk( "\n" );

	wake_up_interruptible( &amp;wq_rx );
	iowrite32( intr_cause, io + E1000_ICR );

	return	IRQ_HANDLED;
}


int my_get_info( char *buf, char **start, off_t off, int count )
{
	int	i, head, tail, n_pkts_recv, n_recv_errs, len = 0;

	// read the Receive-Descriptor Queue's head and tail indices
	head = ioread32( io + E1000_RDH );
	tail = ioread32( io + E1000_RDT );

	// read some RX-related statistical counters
	n_pkts_recv = ioread32( io + E1000_TPR );
	n_recv_errs = ioread32( io + E1000_RXERRC );

	// show the RX-Descriptor Queue
	len += sprintf( buf+len, "\n  Receive-Descriptor Buffer-Area " );
	len += sprintf( buf+len, "(head=%d, tail=%d) \n\n", head, tail );
	for (i = 0; i &lt; 8; i++)
		{
		int	status = rxdesc[i].desc_stat;
		int	errors = rxdesc[i].desc_errs;
		len += sprintf( buf+len, "  #%-2d ", i );
		len += sprintf( buf+len, "%08lX: ", (long)(rxdesc + i) );
		len += sprintf( buf+len, "%016llX ", rxdesc[i].base_addr );
		len += sprintf( buf+len, "%04X ", rxdesc[i].pkt_length );
		len += sprintf( buf+len, "%04X ", rxdesc[i].check_sum );
		len += sprintf( buf+len, "%02X ", rxdesc[i].desc_stat );
		len += sprintf( buf+len, "%02X ", rxdesc[i].desc_errs );
		len += sprintf( buf+len, "%04X ", rxdesc[i].vlan_tag );
		if ( status &amp; (1&lt;&lt;0) ) len += sprintf( buf+len, " DD" );
		if ( status &amp; (1&lt;&lt;1) ) len += sprintf( buf+len, " EOP" );
		if ( status &amp; (1&lt;&lt;2) ) len += sprintf( buf+len, " IXSM" );
		if ( status &amp; (1&lt;&lt;3) ) len += sprintf( buf+len, " VP" );
		if ( status &amp; (1&lt;&lt;5) ) len += sprintf( buf+len, " TCPCS" );
		if ( status &amp; (1&lt;&lt;6) ) len += sprintf( buf+len, " IPCS" );
		if ( status &amp; (1&lt;&lt;7) ) len += sprintf( buf+len, " PIF" );
		len += sprintf( buf+len, " " );
		if ( errors &amp; (1&lt;&lt;0) ) len += sprintf( buf+len, " CE" );
		if ( errors &amp; (1&lt;&lt;2) ) len += sprintf( buf+len, " FE" );
		if ( errors &amp; (1&lt;&lt;5) ) len += sprintf( buf+len, " TCPE" );
		if ( errors &amp; (1&lt;&lt;6) ) len += sprintf( buf+len, " IPE" );
		if ( errors &amp; (1&lt;&lt;7) ) len += sprintf( buf+len, " RXE" );
		len += sprintf( buf+len, "\n" );
		}
	len += sprintf( buf+len, "\n" );

	// show the statistical counters
	len += sprintf( buf+len, "  packets received = %d ", n_pkts_recv );
	len += sprintf( buf+len, "  recv_error_count = %d ", n_recv_errs );
	len += sprintf( buf+len, "\n\n" );

	return	len;
}




ssize_t my_read( struct file *file, char *buf, size_t len, loff_t *pos )
{
	static int	rxhead = 0;
	unsigned char	*from = phys_to_virt( rxdesc[ rxhead ].base_addr );	
	unsigned int	count;

	// sleep if no new packets have been received
	if ( ioread32( io + E1000_RDH ) == rxhead )
		if ( wait_event_interruptible( wq_rx,
			ioread32( io + E1000_RDH ) != rxhead ) ) return -EINTR;

	// get the number of actual data-bytes in this packet	
	count = *(unsigned short*)(from + 14);

	// we cannot copy more bytes than the user's buffer can hold
	if ( count &gt; len ) count = len;

	// copy packet's data to the user's buffer	
	if ( copy_to_user( buf, from+16, count ) ) return -EFAULT;

	// advance our array-index variable to the next descriptor
	rxhead = (1 + rxhead) % 8;

	// tell the kernel how many bytes were transferred
	return	count;
}


struct file_operations my_fops = {
				owner:		THIS_MODULE,
				read:		my_read,
				};


static void __exit my_exit(void )
{
	int	rx_control = ioread32( io + E1000_RCTL );

	// disable the receive engine 
	iowrite32( rx_control &amp; ~(1&lt;&lt;1), io + E1000_RCTL );

	// disable interrupts
	iowrite32( INTR_MASK, io + E1000_IMC );

	// release this driver's kernel resources
	free_irq( irq, modname );
	unregister_chrdev( my_major, devname );
	remove_proc_entry( modname, NULL );
	kfree( kmem );
	iounmap( io );

	// issue confirmation-message to the log-file
	printk( "&lt;1&gt;Removing \'%s\' module\n", modname );
}


static int __init my_init( void )
{
	int	rx_control, i;
	u16	pci_cmd;

	// issue confirmation-message to the log-file
	printk( "&lt;1&gt;\nInstalling \'%s\' module ", modname );
	printk( "(major=%d) \n", my_major );

	// detect the ethernet controller
	devp = pci_get_device( VENDOR_ID, DEVICE_ID, NULL );
	if ( !devp ) return -ENODEV;
	
	// remap the controller's i/o-memory to kernel-space
	iomem_base = pci_resource_start( devp, 0 );
	iomem_size = pci_resource_len( devp, 0 );
	io = ioremap_nocache( iomem_base, iomem_size );
	if ( !io ) return -EBUSY;
	printk( " iomem_base=%08lX ", iomem_base );
	printk( " iomem_size=%08lX ", iomem_size );
	printk( "\n" );

	// report the controller's hardware MAC-address
	memcpy( mac, io + E1000_RA, 6 );
	printk( " MAC-ADDRESS: " );
	for (i = 0; i &lt; 6; i++) 
		{
		printk( "%02X", mac[i] );
		if ( i &lt; 5 ) printk( ":" );
		}
	printk( "\n" );

	// allocate storage for receive-buffers and descriptor-array
	kmem = kzalloc( KMEM_SIZE, GFP_KERNEL );
	if ( !kmem ) return -ENOMEM;
	physaddr = virt_to_phys( kmem );
	printk( " kernel memory at physical address 0x%08lX \n", physaddr );

	// setup receive descriptors
	descaddr = physaddr + (8 * 0x600);
	rxdesc = (RX_DESCRIPTOR*)phys_to_virt( descaddr );
	for (i = 0; i &lt; 8; i++)
		{
		rxdesc[i].base_addr = physaddr + (i * 0x600);
		rxdesc[i].pkt_length = 0;	
		rxdesc[i].check_sum = 0;	
		rxdesc[i].desc_stat = 0;	
		rxdesc[i].desc_errs = 0;	
		rxdesc[i].vlan_tag= 0;	
		}
	init_waitqueue_head( &amp;wq_rx );

	// insure Bus Master bit is set in PCI Command Register
	pci_read_config_word( devp, 4, &amp;pci_cmd );
	pci_cmd |= (1 &lt;&lt; 2);
	pci_write_config_word( devp, 4, pci_cmd );

	// install interrupt handler
	irq = devp-&gt;irq;
	if ( request_irq( irq, my_isr, IRQF_SHARED, modname, &amp;modname ) &lt; 0 )
		{ kfree( kmem ); iounmap( io ); return -EBUSY; }

	// reset the network controller
	iowrite32( 0xFFFFFFFF, io + E1000_IMC );
	iowrite32( 0x040C0241, io + E1000_CTRL );
	iowrite32( 0x000C0241, io + E1000_CTRL );
	udelay( 10000 );

	// TODO: clear the multicast table array
	// TODO: clear the statistical counters
	// TODO: reprogram the filter-address array

	// configure the receive engine 
	rx_control = 0;
	rx_control |= (0&lt;&lt;1);	// EN-bit (Enable Receive Engine)
	rx_control |= (1&lt;&lt;2);	// SPB-bit (Store Bad Packets)
	rx_control |= (1&lt;&lt;3);	// UPE-bit (Unicast Promiscuous Enable) 
	rx_control |= (1&lt;&lt;4);	// MPE-bit (Multicast Promiscuous Enable)
	rx_control |= (0&lt;&lt;5);	// LPE-bit (Long Packet Enable)
	rx_control |= (0&lt;&lt;6);	// LBM=0 (LoopBack Mode off) 
	rx_control |= (0&lt;&lt;8);	// RDMTS=0 (Rx-Descriptor Min Thresh Size)
	rx_control |= (0&lt;&lt;10);	// DTYPE=0 (Descriptor=Type)
	rx_control |= (0&lt;&lt;12);	// MO=0 (Multicast Offset)
	rx_control |= (1&lt;&lt;15);	// BAM-bit (Broadcast Address Enable) 
	rx_control |= (0&lt;&lt;16);	// BSIZE=0 (Receive Buffer Size = 2048)
	rx_control |= (0&lt;&lt;18);	// VLE=0 (VLAN Flter Eable)
	rx_control |= (0&lt;&lt;19);	// CFIEN=0 (Cannonical Form Indicator Enable)
	rx_control |= (0&lt;&lt;20);	// CFI=0 (Canonical Form Indicator bit-value)
	rx_control |= (0&lt;&lt;22);	// DPF=0 (Discard Pause Frames)
	rx_control |= (0&lt;&lt;23);	// PMCF=0 (Pass MAC Control Frames)
	rx_control |= (0&lt;&lt;25);	// BSEX=0 (Buffer Size Extension)
	rx_control |= (1&lt;&lt;26);	// SECRC-bit (Strip Ethernet CRC)
	rx_control |= (0&lt;&lt;27);	// FLXBUF=0 (Flexible Buffer-size)
	iowrite32( rx_control, io + E1000_RCTL );

	iowrite32( 0x000C0241, io + E1000_CTRL );	// Device Control
	iowrite32( 0x1C1401C0, io + E1000_CTRL_EXT );	// Extended Control
	iowrite32(   descaddr, io + E1000_RDBAL );	
	iowrite32( 0x00000000, io + E1000_RDBAH );
	iowrite32( 0x00000080, io + E1000_RDLEN );
	iowrite32( 0x00000000, io + E1000_RDH );
	iowrite32( 0x00000008, io + E1000_RDT );
	iowrite32( 0x01010000, io + E1000_RXDCTL );

	// disable receive-checksum offloading and packet-splitting
	iowrite32( 0x00000000, io + E1000_RXCSUM );	// Rx-Checksum Control
	iowrite32( 0x00000000, io + E1000_RFCTL );	// Rx-Filter Control
	iowrite32( 0x00000000, io + E1000_PSRCTL );	// Packet-Split Rx Ctrl

	// enable the receive engine
	iowrite32( rx_control | (1&lt;&lt;1), io + E1000_RCTL );

	// enable interrupts
	iowrite32( 0xFFFFFFFF, io + E1000_ICR );
	iowrite32( INTR_MASK, io + E1000_IMS );

	// create pseudo-file and register this device-driver
	create_proc_info_entry( modname, 0, NULL, my_get_info );
	return	register_chrdev( my_major, devname, &amp;my_fops );
}

module_init( my_init );
module_exit( my_exit );
MODULE_LICENSE("GPL");</code></pre>
<blockquote><p> 由于时间关系，上述代码还不能运行，大家可以调试下。。。</p>
</blockquote>

                <!-- <hr/>
                    <div id="disqus_thread"></div>
                    <script type="text/javascript">
                       /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                       var disqus_shortname = 'uliwebzone'; // required: replace example with your forum shortname
            
                       /* * * DON'T EDIT BELOW THIS LINE * * */
                       (function() {
                           var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                           dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                           (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                       })();
                   </script>
                   <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                   <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                -->
                    <div class="tutorial-footer">
                        <p>评论 <a id="global-comment-count" href="/tutorial/view_paragraph_comments/95?para=0" class="para-comments-count active right animated">0</a>
                            <span class="gray">valley 于 2013-01-11 06:49:17+00:00 更新</span>
                        </p>
                    </div>
                    
                    <!-- JiaThis Button BEGIN -->
<script type="text/javascript" src="http://v3.jiathis.com/code/jiathis_r.js?uid=1342595503212835&type=left&amp;btn=l1.gif" charset="utf-8"></script>
<!-- JiaThis Button END -->
<script src="http://mediaplayer.yahoo.com/js"></script>

                
                    <div class="alert alert-info">
                        <a href="#" class="close" data-dismiss="alert">&times;</a>
                        可以使用<i class="icon-arrow-left"></i>和<i class="icon-arrow-right"></i>来跳转到前一章节或后一章节。
                        还可以使用<b>回车</b>来扩展或缩小文章区域。<b>C</b>键打开评论，<b>ESC</b>关闭评论。
                    </div>
                
                    <div class="chapter-prev chapter-down animated">
                        <a prev-chapter href="/tutorial/view_chapter/148.html"><i class="icon-arrow-left"></i> 3.4 驱动模块之块设备</a>
                    </div>
                    <div class="chapter-next chapter-down animated">
                        <a next-chapter href="/tutorial/view_chapter/122.html">3.6 硬件常识 <i class="icon-arrow-right"></i></a>
                    </div>
                    
                </div>
                
            </div>
        </div>
        <div class="span3" id="right-side">
            
            <div id="toc-container" class="nano">
            <div id="toc" class="content"></div>
            </div>
        </div>
    </div>
</div>
<div id="para-comments" style="display:none;">
</div>
<style>
#toc {top:140px;}
</style>
<script>
    function viewport()
    {
        var e = window, a = 'inner';
        if ( !( 'innerWidth' in window ) )
        {
            a = 'client';
            e = document.documentElement || document.body;
        }
        return { width : e[ a+'Width' ] , height : e[ a+'Height' ] }
    }
    
    //滚动插件
    /*(function () {
      $.fn.anchorScroll = function (options) {
        var defaults = {
          speed: 1100,
          fx: "jswing",
          offset: 0
        };
        //var version =  "1.0";
        var options = $.extend(defaults, options);
        return $(this).each(function () {
          var element = this;
          $(element).click(function (event) {
            var elementClick = $(element).attr("href").replace(/\./g, '\\.');
            var destination = $(elementClick).offset().top - options.offset;
            $("html,body").animate({
              scrollTop: destination
            }, options.speed, options.fx);
            //Stop links default events
            event.preventDefault();
            return false;
          })
        })
      }
    })(jQuery);
    */
    

    $(function(){
        //实现代码高亮
        window.prettyPrint && prettyPrint();
        
        //増加标题探测
        //$('body').scrollspy({target:'#titles', offset:50});
        
        $.ajax({
            type:'GET',
            dateType:'json',
            url:'/tutorial/get_paragraph_comments_count/95',
            success:function(data){
                //増加气泡评论显示
                $('a.comment_point').each(function(index, el){
                    var id = $(el).attr('rel');
                    var count = id in data?data[id]:0;
                    var item = $('<a href="/tutorial/view_paragraph_comments/95?para=' + id + '" class="para-comments-count animated">'+count+'</a>')
                        .css({position:'absolute', left:'-50px'});
                    $(el).closest('p').prepend(item);
                });
                
                if (data['0']){
                    $('#global-comment-count').text(data['0']);
                }
                //处理pageslide
                $('a.para-comments-count').pageslide({
                    //'href':'#para-comments',
                    iframe:false,
                    direction:'right',
                    width: '400px',
                    onClick: function(e){
                        $('a.para-comments-count').removeClass('active');
                        $(this).addClass('active');
                        //处理toTop
                        reset_totop();
                    },
                    onClose: function(){
                        $('a.para-comments-count').removeClass('active');
                        //处理toTop
                        reset_totop();
                    }
                });
                
            }
        });
        /*
        $('p.tutorial_p').hover(function(e){
            $(this).find('a.para-comments-count').addClass('swing');
        }, function(e){
            $(this).find('a.para-comments-count').removeClass('swing');
        });
        */
        
        $('.chapter-prev, .chapter-next').hover(function(e){
            $(this).animate({opacity:1}, 500);
        }, function(e){
            $(this).animate({opacity:0.5}, 500);;
        });
        
        //増加限制目录区高度的处理
        //$('#titles').height(viewport().height - 160);
        
        //限定pageslide的高度
        //$('#pageslide').height(viewport().height - 160);
        //实现平滑滚动
        //$('#titles a').anchorScroll({offset:50});
        
        function setup_toc(){
            $('#toc').height(viewport().height - $('#toc').offset()['top'] - 40);
            $('#toc').toc({
                'selectors': 'h2,h3', //elements to use as headings
                'highlightOffset': 0, //offset to trigger the next headline
                'offset': 50
            });
        }
        
        setup_toc();
        
        $(window).resize(function(){
        	setup_toc();
        });
        
        
        //増加代码提示
        $('pre, .inline-tag').code_comment();
        
        //处理回到顶部显示
        $('.outter').UItoTop({ easingType: 'easeOutQuart', text:'<i class="icon-arrow-up"></i>回到顶部' });
        
        //处理动态滚动条
        //$("#toc-container").nanoScroller();
        
        //处理左键，右键前后翻页
        $(document).bind('keydown.left', function(){
            var el = $('a[prev-chapter]');
            if (el.length>0){
                el[0].click();
            }
        }).bind('keydown.right', function(){
            var el = $('a[next-chapter]');
            if (el.length>0){
                el[0].click();
            }
        }).bind('keydown.return', function(){
            $('.expander').click();
        }).bind('keydown.c', function(){
            $('a.para-comments-count').click();
        });
        
        function reset_totop(){
            var top = $('#toTop');
            var that = $('.outter');
            var left = $(that).outerWidth() + $(that).offset().left + 2;
            top.offset({left:left, bottom:10});
        }
        
        //处理expander事件，如果点击，则隐藏目录栏
        $('.expander').click({'opened':false}, function(e){
            if (!e.data.opened){
                $('#article').removeClass('span8').addClass('span12');
                $('#right-side').removeClass('span4').hide();
                e.data.opened = true;
                $(this).html('&laquo;');
            }else{
                $('#article').removeClass('span12').addClass('span8');
                $('#right-side').addClass('span4').show();
                e.data.opened = false;
                $(this).html('&raquo;');
            }
            //处理toTop
            reset_totop();
        });
        
    });
</script>



<div class="container">
  <footer class="row">
  
<p>
Uliweb
</p>

  </footer>
</div>
      


<!-- bottomlinks -->
<script>$.ajaxSetup({cache:false, traditional:true});</script>
<script type="text/javascript" src="/static/pageslide/jquery.pageslide.js?ver=2"></script>
<script type="text/javascript" src="/static/toc/toc.js?ver=2"></script>


  </body>
</html>
